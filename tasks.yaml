includes:
  - bundles: ./tasks/bundles.yaml

variables:
  - name: REGISTRY
    description: "Remote OCI registry for the Core package"
    default: "ghcr.io/uds-packages"
  - name: PACKAGE_NAME
    default: "postgres-operator"
  - name: PACKAGE_VERSION
    description: "Version of the package"
    default: "7.1.1-uds.6"
  - name: PACKAGE_FLAVOR
    default: "upstream"
  - name: ARCHITECTURE
    description: "System architecture (amd64 or arm64)"
    default: ""
  - name: CONFIG_FILE
    description: "Path to the zarf config file"
    default: "zarf-config.toml"

tasks:
  - name: pull
    description: "Pull Core package from OCI registry"
    actions:
      - description: "Pull Core package from OCI registry"
        cmd: |
          echo "Pulling Core package ${PACKAGE_NAME}:${PACKAGE_VERSION}-${PACKAGE_FLAVOR} from ${REGISTRY}"

          ARCH_FLAG=""
          if [ -n "${ARCHITECTURE}" ]; then
            ARCH_FLAG="-a ${ARCHITECTURE}"
            echo "Using specified architecture: ${ARCHITECTURE}"
          else
            echo "Using auto-detected architecture"
          fi

          uds zarf package pull ${ARCH_FLAG} oci://${REGISTRY}/${PACKAGE_NAME}:${PACKAGE_VERSION}-${PACKAGE_FLAVOR}
        env:
          - ZARF_LOG_LEVEL=info

  - name: deploy
    description: "Deploy Core package"
    actions:
      - description: "Deploy Core package with defined zarf-config.toml"
        cmd: |
          ZARF_CONFIG="$CONFIG_FILE" uds zarf package deploy zarf-package-*-${PACKAGE_VERSION}-${PACKAGE_FLAVOR}.tar.zst \
            --confirm

  - name: clean
    description: "Remove local Zarf package files"
    actions:
      - description: "Clean up local Zarf package & UDS Bundle tarballs"
        cmd: |
          echo "Cleaning up local UDS Zarf packages"
          rm -f zarf-package-*.tar.zst
          echo "Package files removed"
          echo "Cleaning up local UDS Bundles"
          rm -f uds-bundle-*.tar.zst
          echo "Bundle files removed"

  # First change the PACKAGE_VERSION in the variables section above to create a different version,
  # it will result in the uds-bundle.yaml being updated with the new version and ref for core. I 
  # couldn't get renovate to do this cleanly.
  - name: create-bundle
    description: |
      "Create a single package bundle for Core. This 
      allows for granular control over helm chart values."
    actions:
      - task: bundles:update-bundle-version
      - task: bundles:create

